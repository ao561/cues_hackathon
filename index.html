<!DOCTYPE html>
<html>
    <head>
        <title>âœ¨ Cues Chat - Premium Experience</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
        <style>
            :root {
                /* Default Theme - Ocean Blue */
                --primary-color: #0084ff;
                --primary-hover: #006fd6;
                --secondary-color: #00c851;
                --secondary-hover: #00a142;
                --accent-color: #ff006e;
                --bg-gradient-start: #667eea;
                --bg-gradient-end: #764ba2;
                --bg-light: #f5f7fb;
                --bg-dark: #1a1d21;
                --text-light: #050505;
                --text-dark: #e4e6eb;
                --msg-self-light: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                --msg-self-dark: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                --msg-other-light: rgba(255, 255, 255, 0.9);
                --msg-other-dark: rgba(58, 59, 60, 0.9);
                --sidebar-light: rgba(255, 255, 255, 0.8);
                --sidebar-dark: rgba(36, 37, 38, 0.8);
                --border-light: rgba(221, 223, 226, 0.6);
                --border-dark: rgba(58, 59, 60, 0.6);
                --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.2);
                --glass-bg: rgba(255, 255, 255, 0.1);
                --glass-border: rgba(255, 255, 255, 0.2);
            }

            /* Sunset Theme */
            body.theme-sunset {
                --primary-color: #ff6b6b;
                --bg-gradient-start: #ff6b6b;
                --bg-gradient-end: #feca57;
                --msg-self-light: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                --msg-self-dark: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                --accent-color: #ee5a6f;
            }

            /* Forest Theme */
            body.theme-forest {
                --primary-color: #00d2ff;
                --bg-gradient-start: #1dd1a1;
                --bg-gradient-end: #10ac84;
                --msg-self-light: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%);
                --msg-self-dark: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%);
                --accent-color: #0abde3;
            }

            /* Cyberpunk Theme */
            body.theme-cyberpunk {
                --primary-color: #f368e0;
                --bg-gradient-start: #ff9ff3;
                --bg-gradient-end: #00d2ff;
                --msg-self-light: linear-gradient(135deg, #f368e0 0%, #48dbfb 100%);
                --msg-self-dark: linear-gradient(135deg, #f368e0 0%, #48dbfb 100%);
                --accent-color: #ff9ff3;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body { 
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                display: flex;
                flex-direction: row;
                height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
                color: var(--text-light);
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }

            body.dark-mode {
                background: linear-gradient(135deg, #1a1d21 0%, #2d3436 100%);
                color: var(--text-dark);
            }

            /* Header */
            #header {
                background: white;
                padding: 16px 24px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: var(--shadow);
                position: relative;
                z-index: 10;
            }

            body.dark-mode #header {
                background: var(--sidebar-dark);
            }

            #header h1 {
                font-size: 24px;
                font-weight: 700;
                background: linear-gradient(135deg, #0084ff, #00c851);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            #theme-toggle {
                background: none;
                border: 2px solid var(--border-light);
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            }

            body.dark-mode #theme-toggle {
                border-color: var(--border-dark);
            }

            #theme-toggle:hover {
                transform: scale(1.1);
                box-shadow: var(--shadow-hover);
            }

            /* Main container */
            #main-container {
                display: flex;
                flex-direction: row;
                flex: 1;
                overflow: hidden;
                position: relative;
                z-index: 1;
            }

            /* Sidebar - Glassmorphism */
            #sidebar {
                width: 320px;
                background: var(--sidebar-light);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-right: 1px solid var(--glass-border);
                display: flex;
                flex-direction: column;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }

            body.dark-mode #sidebar {
                background: var(--sidebar-dark);
                border-right-color: rgba(255, 255, 255, 0.1);
            }

            #sidebar-header {
                padding: 20px;
                border-bottom: 1px solid var(--border-light);
            }

            body.dark-mode #sidebar-header {
                border-bottom-color: var(--border-dark);
            }

            #sidebar-header h2 {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #65676b;
            }

            body.dark-mode #sidebar-header h2 {
                color: #b0b3b8;
            }

            #online-users {
                list-style: none;
                padding: 12px;
                overflow-y: auto;
                flex: 1;
            }

            .user-item {
                padding: 12px 16px;
                margin-bottom: 4px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .user-item:hover {
                background: var(--bg-light);
            }

            body.dark-mode .user-item:hover {
                background: var(--bg-dark);
            }

            .user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                color: white;
                position: relative;
                flex-shrink: 0;
            }

            .online-indicator {
                width: 12px;
                height: 12px;
                background: var(--secondary-color); /* <-- This is the fix */
                border: 2px solid white;
                border-radius: 50%;
                position: absolute;
                bottom: 0;
                right: 0;
            }

            body.dark-mode .online-indicator {
                border-color: var(--sidebar-dark);
            }

            .user-info {
                flex: 1;
                min-width: 0;
            }

            .user-name {
                font-weight: 500;
                font-size: 14px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .user-status {
                font-size: 12px;
                color: var(--success-color);
                margin-top: 2px;
            }

            /* Chat area - Glassmorphism */
            #chat-area {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: rgba(255, 255, 255, 0.3);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-left: 1px solid rgba(255, 255, 255, 0.2);
                margin: 16px 16px 16px 0;
                border-radius: 24px;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }

            body.dark-mode #chat-area {
                background: rgba(36, 37, 38, 0.3);
                border-left-color: rgba(255, 255, 255, 0.1);
            }

            #messages { 
                list-style-type: none; 
                padding: 20px;
                overflow-y: auto; 
                flex-grow: 1; 
                display: flex;
                flex-direction: column;
                gap: 8px;
                scroll-behavior: smooth;
            }

            #messages::-webkit-scrollbar {
                width: 8px;
            }

            #messages::-webkit-scrollbar-track {
                background: transparent;
            }

            #messages::-webkit-scrollbar-thumb {
                background: #c4c4c4;
                border-radius: 4px;
            }

            body.dark-mode #messages::-webkit-scrollbar-thumb {
                background: #4a4a4a;
            }

            #messages li { 
                padding: 14px 18px; 
                border-radius: 20px; 
                max-width: 65%;
                word-wrap: break-word;
                animation: messageSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
                position: relative;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            #messages li:hover {
                transform: translateY(-2px) scale(1.01);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }

            @keyframes messageSlideIn {
                0% {
                    opacity: 0;
                    transform: translateY(30px) scale(0.95);
                }
                50% {
                    opacity: 0.8;
                }
                100% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .message-self { 
                background: var(--msg-self-light);
                color: white;
                align-self: flex-end;
                border-bottom-right-radius: 6px;
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            }

            body.dark-mode .message-self {
                background: var(--msg-self-dark);
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            }

            .message-other { 
                background: var(--msg-other-light);
                color: var(--text-light);
                align-self: flex-start;
                border-bottom-left-radius: 6px;
            }

            body.dark-mode .message-other {
                background: var(--msg-other-dark);
                color: var(--text-dark);
            }

            .message-other .sender-info {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(0,0,0,0.1);
            }

            body.dark-mode .message-other .sender-info {
                border-bottom-color: rgba(255,255,255,0.1);
            }

            .message-other .sender-avatar {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: 600;
                color: white;
                flex-shrink: 0;
            }

            .message-other .sender-name {
                font-weight: 600;
                font-size: 13px;
                color: #050505;
            }

            body.dark-mode .message-other .sender-name {
                color: #e4e6eb;
            }

            .message-content {
                line-height: 1.5;
                font-size: 15px;
                white-space: pre-wrap; /* <-- This is the fix */
            }

            .message-timestamp {
                font-size: 11px;
                margin-top: 6px;
                opacity: 0.7;
                text-align: right;
            }

            .message-self .message-timestamp {
                color: rgba(255,255,255,0.9);
            }

            .message-other .message-timestamp {
                color: #65676b;
            }

            body.dark-mode .message-other .message-timestamp {
                color: #b0b3b8;
            }

            /* Mention styles */
            .message-mentioned {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                border: 2px solid #ffd700;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .message-mentioned .sender-name,
            .message-mentioned .message-timestamp {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            .mention {
                background: rgba(0, 132, 255, 0.2);
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 600;
                color: #0084ff;
            }

            body.dark-mode .mention {
                background: rgba(0, 132, 255, 0.3);
                color: #64b5f6;
            }

            .message-self .mention {
                background: rgba(255, 255, 255, 0.3);
                color: white;
            }

            /* Reply styles */
            .message-reply {
                background: rgba(0, 0, 0, 0.05);
                border-left: 3px solid var(--primary-color);
                padding: 8px 10px;
                margin-bottom: 8px;
                border-radius: 6px;
                font-size: 13px;
                cursor: pointer;
                transition: background 0.2s;
            }

            body.dark-mode .message-reply {
                background: rgba(255, 255, 255, 0.05);
            }

            .message-reply:hover {
                background: rgba(0, 0, 0, 0.08);
            }

            body.dark-mode .message-reply:hover {
                background: rgba(255, 255, 255, 0.08);
            }

            .message-reply .reply-sender {
                font-weight: 600;
                color: var(--primary-color);
                margin-bottom: 2px;
            }

            .message-reply .reply-text {
                color: #65676b;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            body.dark-mode .message-reply .reply-text {
                color: #b0b3b8;
            }

            .message-actions {
                position: absolute;
                top: -12px;
                right: 12px;
                display: none;
                gap: 4px;
                background: white;
                border-radius: 12px;
                padding: 4px;
                box-shadow: var(--shadow-hover);
                z-index: 10;
            }

            body.dark-mode .message-actions {
                background: var(--sidebar-dark);
            }

            #messages li:hover .message-actions {
                display: flex;
            }

            .message-action-btn {
                background: none;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            }

            .message-action-btn:hover {
                background: var(--bg-light);
            }

            body.dark-mode .message-action-btn:hover {
                background: var(--bg-dark);
            }

            /* Reply preview bar */
            #reply-preview {
                display: none;
                background: var(--bg-light);
                border-top: 1px solid var(--border-light);
                padding: 12px 20px;
                align-items: center;
                gap: 12px;
            }

            body.dark-mode #reply-preview {
                background: rgba(255, 255, 255, 0.05);
                border-top-color: var(--border-dark);
            }

            #reply-preview.show {
                display: flex;
            }

            .reply-preview-content {
                flex: 1;
                min-width: 0;
            }

            .reply-preview-title {
                font-size: 12px;
                color: var(--primary-color);
                font-weight: 600;
                margin-bottom: 4px;
            }

            .reply-preview-text {
                font-size: 14px;
                color: #65676b;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            body.dark-mode .reply-preview-text {
                color: #b0b3b8;
            }

            #cancel-reply-btn {
                background: none;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #65676b;
                transition: all 0.2s;
            }

            #cancel-reply-btn:hover {
                background: rgba(0, 0, 0, 0.1);
                color: #f44336;
            }

            body.dark-mode #cancel-reply-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            /* Mention dropdown */
            #mention-dropdown {
                position: absolute;
                bottom: 100%;
                left: 20px;
                right: 20px;
                background: white;
                border: 1px solid var(--border-light);
                border-radius: 8px;
                box-shadow: var(--shadow-hover);
                max-height: 200px;
                overflow-y: auto;
                display: none;
                z-index: 100;
            }

            body.dark-mode #mention-dropdown {
                background: var(--sidebar-dark);
                border-color: var(--border-dark);
            }

            #mention-dropdown.show {
                display: block;
            }

            .mention-item {
                padding: 10px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                transition: background 0.2s;
            }

            .mention-item:hover,
            .mention-item.selected {
                background: var(--bg-light);
            }

            body.dark-mode .mention-item:hover,
            body.dark-mode .mention-item.selected {
                background: var(--bg-dark);
            }

            .mention-item-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 600;
                color: white;
                flex-shrink: 0;
            }

            .mention-item-name {
                font-size: 14px;
                font-weight: 500;
            }

            .message-reactions {
                display: flex;
                gap: 6px;
                margin-top: 8px;
                flex-wrap: wrap;
                animation: fadeIn 0.3s ease;
            }

            .reaction {
                background: rgba(255, 255, 255, 0.95);
                border-radius: 16px;
                padding: 4px 10px;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                border: 2px solid transparent;
            }

            body.dark-mode .reaction {
                background: rgba(255, 255, 255, 0.15);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            .reaction:hover {
                transform: scale(1.2) rotate(5deg);
                border-color: var(--primary-color);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .reaction:active {
                transform: scale(1.1);
            }

            .reaction-count {
                font-size: 12px;
                font-weight: 700;
                color: var(--primary-color);
            }

            /* Reaction popup */
            .reaction-picker {
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%) translateY(-10px);
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 30px;
                padding: 8px 12px;
                display: none;
                gap: 8px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                z-index: 100;
                animation: reactionPopIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            body.dark-mode .reaction-picker {
                background: rgba(36, 37, 38, 0.95);
            }

            .reaction-picker.show {
                display: flex;
            }

            @keyframes reactionPopIn {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(0) scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(-10px) scale(1);
                }
            }

            .reaction-option {
                font-size: 24px;
                cursor: pointer;
                transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
                padding: 4px;
                border-radius: 50%;
            }

            .reaction-option:hover {
                transform: scale(1.3) rotate(10deg);
                background: rgba(0, 0, 0, 0.05);
            }

            body.dark-mode .reaction-option:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            /* Typing indicator */
            #typing-indicator {
                padding: 8px 20px;
                font-size: 13px;
                color: #65676b;
                font-style: italic;
                min-height: 30px;
            }

            body.dark-mode #typing-indicator {
                color: #b0b3b8;
            }

            .typing-dots {
                display: inline-flex;
                gap: 4px;
                align-items: center;
            }

            .typing-dots span {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: #65676b;
                animation: typing 1.4s infinite;
            }

            body.dark-mode .typing-dots span {
                background: #b0b3b8;
            }

            .typing-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes typing {
                0%, 60%, 100% {
                    transform: translateY(0);
                    opacity: 0.7;
                }
                30% {
                    transform: translateY(-8px);
                    opacity: 1;
                }
            }

            /* Input area - Glassmorphism */
            .form-container { 
                display: flex;
                align-items: center;
                padding: 20px 24px;
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-top: 1px solid rgba(255, 255, 255, 0.3);
                gap: 14px;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            }

            body.dark-mode .form-container {
                background: rgba(36, 37, 38, 0.8);
                border-top-color: rgba(255, 255, 255, 0.1);
            }

            #emoji-picker-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                transition: background 0.2s;
                flex-shrink: 0;
            }

            #emoji-picker-btn:hover {
                background: var(--bg-light);
            }

            body.dark-mode #emoji-picker-btn:hover {
                background: var(--bg-dark);
            }

            .input-wrapper {
                flex: 1;
                position: relative;
            }

            .form-container input { 
                border: 1px solid var(--border-light);
                padding: 12px 80px 12px 16px;
                width: 100%;
                border-radius: 24px;
                font-size: 15px;
                font-family: inherit;
                background: var(--bg-light);
                color: var(--text-light);
                transition: all 0.2s;
            }

            body.dark-mode .form-container input {
                background: var(--bg-dark);
                color: var(--text-dark);
                border-color: var(--border-dark);
            }

            .form-container input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(0,132,255,0.1);
            }

            #char-counter {
                position: absolute;
                right: 16px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 12px;
                color: #65676b;
                pointer-events: none;
            }

            body.dark-mode #char-counter {
                color: #b0b3b8;
            }

            #char-counter.warning {
                color: #ff9800;
                font-weight: 600;
            }

            #char-counter.error {
                color: #f44336;
                font-weight: 600;
            }

            .form-container button { 
                border: none;
                padding: 14px 28px;
                border-radius: 28px;
                cursor: pointer;
                font-weight: 700;
                font-size: 15px;
                font-family: 'Inter', sans-serif;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                flex-shrink: 0;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                position: relative;
                overflow: hidden;
            }

            .form-container button::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.4);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            .form-container button:active::after {
                width: 300px;
                height: 300px;
            }

            .form-container button:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            }

            .form-container button:active {
                transform: translateY(-1px) scale(1.02);
            }

            .form-container button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            #name-form button { 
                background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
                color: white;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            #name-form button:hover:not(:disabled) {
                background: linear-gradient(135deg, var(--bg-gradient-end), var(--bg-gradient-start));
            }

            #chat-form button { 
                background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
                color: white;
                font-weight: 700;
            }

            #chat-form button:hover:not(:disabled) {
                background: linear-gradient(135deg, var(--bg-gradient-end), var(--bg-gradient-start));
            }

            /* Emoji picker */
            #emoji-picker {
                position: absolute;
                bottom: 80px;
                left: 20px;
                background: white;
                border: 1px solid var(--border-light);
                border-radius: 12px;
                padding: 16px;
                box-shadow: var(--shadow-hover);
                display: none;
                max-width: 320px;
                z-index: 100;
            }

            body.dark-mode #emoji-picker {
                background: var(--sidebar-dark);
                border-color: var(--border-dark);
            }

            #emoji-picker.show {
                display: block;
                animation: slideUp 0.2s ease-out;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .emoji-grid {
                display: grid;
                grid-template-columns: repeat(8, 1fr);
                gap: 8px;
                max-height: 200px;
                overflow-y: auto;
            }

            .emoji-item {
                font-size: 24px;
                cursor: pointer;
                padding: 8px;
                border-radius: 8px;
                text-align: center;
                transition: all 0.2s;
            }

            .emoji-item:hover {
                background: var(--bg-light);
                transform: scale(1.3);
            }

            body.dark-mode .emoji-item:hover {
                background: var(--bg-dark);
            }

            /* Name entry screen */
            #name-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            #name-container .form-container {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                padding: 56px;
                border-radius: 32px;
                box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
                max-width: 450px;
                width: 90%;
                flex-direction: column;
                gap: 28px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                animation: welcomeSlideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            @keyframes welcomeSlideUp {
                from {
                    opacity: 0;
                    transform: translateY(50px) scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            body.dark-mode #name-container .form-container {
                background: rgba(36, 37, 38, 0.95);
                border-color: rgba(255, 255, 255, 0.1);
            }

            #name-container h2 {
                font-size: 36px;
                font-weight: 800;
                text-align: center;
                margin-bottom: 8px;
                color: var(--text-light);
                font-family: 'Poppins', sans-serif;
                background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            body.dark-mode #name-container h2 {
                background: linear-gradient(135deg, #667eea, #764ba2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            #name-container p {
                text-align: center;
                color: #65676b;
                margin-bottom: 16px;
            }

            body.dark-mode #name-container p {
                color: #b0b3b8;
            }

            #name-form {
                display: flex;
                flex-direction: column;
                gap: 16px;
                width: 100%;
            }

            #name-form input {
                padding: 16px;
                font-size: 16px;
                border-radius: 12px;
            }

            #name-form button {
                width: 100%;
                padding: 16px;
                font-size: 16px;
            }

            /* Toast notifications */
            #toast-container {
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 1001;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .toast {
                background: white;
                padding: 16px 20px;
                border-radius: 12px;
                box-shadow: var(--shadow-hover);
                display: flex;
                align-items: center;
                gap: 12px;
                min-width: 280px;
                animation: slideInRight 0.3s ease-out;
                border-left: 4px solid var(--primary-color);
            }

            body.dark-mode .toast {
                background: var(--sidebar-dark);
            }

            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .toast.success {
                border-left-color: var(--success-color);
            }

            .toast.info {
                border-left-color: var(--primary-color);
            }

            .toast-icon {
                font-size: 20px;
                flex-shrink: 0;
            }

            .toast-content {
                flex: 1;
            }

            .toast-title {
                font-weight: 600;
                margin-bottom: 4px;
                font-size: 14px;
            }

            .toast-message {
                font-size: 13px;
                color: #65676b;
            }

            body.dark-mode .toast-message {
                color: #b0b3b8;
            }

            .hidden { 
                display: none !important;
            }

            /* Loading spinner */
            .loading-spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255,255,255,0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Responsive design */
            @media (max-width: 768px) {
                #sidebar {
                    position: fixed;
                    left: -300px;
                    height: 100%;
                    z-index: 100;
                    transition: left 0.3s;
                }

                #sidebar.show {
                    left: 0;
                }

                #main-container {
                    flex-direction: column;
                }

                #messages li {
                    max-width: 85%;
                }

                .form-container {
                    padding: 12px;
                }

                #emoji-picker {
                    bottom: 70px;
                    left: 10px;
                    right: 10px;
                    max-width: none;
                }

                #toast-container {
                    left: 10px;
                    right: 10px;
                }

                .toast {
                    min-width: auto;
                }
            }

            /* Accessibility */
            @media (prefers-reduced-motion: reduce) {
                *, *::before, *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }

            /* File attachment button */
            #file-attach-btn {
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                transition: background 0.2s;
                flex-shrink: 0;
            }

            #file-attach-btn:hover {
                background: var(--bg-light);
            }

            body.dark-mode #file-attach-btn:hover {
                background: var(--bg-dark);
            }

            /* Sound toggle */
            #sound-toggle {
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                padding: 8px;
                opacity: 0.6;
                transition: all 0.3s;
                border-radius: 50%;
            }

            #sound-toggle:hover {
                opacity: 1;
                background: rgba(0, 0, 0, 0.05);
                transform: scale(1.1);
            }

            /* Scroll to bottom button */
            #scroll-to-bottom {
                position: fixed;
                bottom: 100px;
                right: 40px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: var(--primary-color);
                color: white;
                border: none;
                font-size: 24px;
                cursor: pointer;
                box-shadow: 0 4px 20px rgba(0, 132, 255, 0.4);
                z-index: 50;
                display: none;
                align-items: center;
                justify-content: center;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                animation: bounceIn 0.5s;
            }

            #scroll-to-bottom.show {
                display: flex;
            }

            #scroll-to-bottom:hover {
                transform: scale(1.1) translateY(-5px);
                box-shadow: 0 8px 30px rgba(0, 132, 255, 0.6);
            }

            #scroll-to-bottom:active {
                transform: scale(0.95);
            }

            @keyframes bounceIn {
                0% {
                    opacity: 0;
                    transform: scale(0.3) translateY(100px);
                }
                50% {
                    opacity: 1;
                    transform: scale(1.05);
                }
                70% {
                    transform: scale(0.9);
                }
                100% {
                    transform: scale(1);
                }
            }

            /* Unread badge */
            #unread-badge {
                position: absolute;
                top: -5px;
                right: -5px;
                background: var(--accent-color);
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: none;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: 700;
                box-shadow: 0 2px 8px rgba(255, 0, 110, 0.4);
                animation: pulse 2s ease-in-out infinite;
            }

            #unread-badge.show {
                display: flex;
            }

            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                    box-shadow: 0 2px 8px rgba(255, 0, 110, 0.4);
                }
                50% {
                    transform: scale(1.1);
                    box-shadow: 0 4px 16px rgba(255, 0, 110, 0.6);
                }
            }

            /* Theme Switcher Panel */
            #theme-switcher {
                position: fixed;
                top: 80px;
                right: 20px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                display: none;
                flex-direction: column;
                gap: 12px;
                z-index: 100;
                animation: slideInRight 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            body.dark-mode #theme-switcher {
                background: rgba(36, 37, 38, 0.95);
            }

            #theme-switcher.show {
                display: flex;
            }

            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(50px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .theme-option {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s;
                background: transparent;
                border: 2px solid transparent;
            }

            .theme-option:hover {
                background: rgba(0, 0, 0, 0.05);
                transform: translateX(5px);
            }

            body.dark-mode .theme-option:hover {
                background: rgba(255, 255, 255, 0.05);
            }

            .theme-option.active {
                border-color: var(--secondary-color);
                background: rgba(0, 200, 81, 0.1); /* Transparent version of --secondary-color */
            }

            .theme-preview {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .theme-ocean {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .theme-sunset-preview {
                background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            }

            .theme-forest-preview {
                background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%);
            }

            .theme-cyberpunk-preview {
                background: linear-gradient(135deg, #f368e0 0%, #48dbfb 100%);
            }

            .theme-name {
                font-weight: 600;
                font-size: 14px;
            }

            /* Message grouping headers */
            .message-date-divider {
                text-align: center;
                padding: 16px 0;
                font-size: 12px;
                font-weight: 600;
                color: rgba(0, 0, 0, 0.4);
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            body.dark-mode .message-date-divider {
                color: rgba(255, 255, 255, 0.4);
            }

            /* Loading skeleton */
            .skeleton {
                background: linear-gradient(90deg, 
                    rgba(255, 255, 255, 0.1) 25%, 
                    rgba(255, 255, 255, 0.2) 50%, 
                    rgba(255, 255, 255, 0.1) 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
                border-radius: 8px;
            }

            @keyframes shimmer {
                0% {
                    background-position: 200% 0;
                }
                100% {
                    background-position: -200% 0;
                }
            }

            /* Enhanced input focus */
            .form-container input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 4px rgba(0, 132, 255, 0.15), 0 0 20px rgba(0, 132, 255, 0.2);
                transform: translateY(-2px);
            }

            /* Button pulse effect */
            .form-container button {
                position: relative;
                overflow: hidden;
            }

            .form-container button::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.5);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            .form-container button:active::before {
                width: 300px;
                height: 300px;
            }
        </style>
    </head>
    <body>
        <div id="toast-container"></div>

        <button id="scroll-to-bottom" title="Scroll to bottom">
            â†“
            <span id="unread-badge">0</span>
        </button>

        <div id="theme-switcher">
            <h3 style="margin-bottom: 8px; font-size: 16px;">Choose Theme</h3>
            <div class="theme-option active" data-theme="ocean">
                <div class="theme-preview theme-ocean">ðŸŒŠ</div>
                <div class="theme-name">Ocean Blue</div>
            </div>
            <div class="theme-option" data-theme="sunset">
                <div class="theme-preview theme-sunset-preview">ðŸŒ…</div>
                <div class="theme-name">Sunset Glow</div>
            </div>
            <div class="theme-option" data-theme="forest">
                <div class="theme-preview theme-forest-preview">ðŸŒ²</div>
                <div class="theme-name">Forest Green</div>
            </div>
            <div class="theme-option" data-theme="cyberpunk">
                <div class="theme-preview theme-cyberpunk-preview">ðŸŽ®</div>
                <div class="theme-name">Cyberpunk</div>
            </div>
        </div>

        <div id="name-container">
            <div class="form-container">
                <div>
                    <h2>âœ¨ Welcome to OmniPlan Chat âœ¨</h2>
                    <p style="font-size: 15px; font-weight: 500;">Experience the next generation of group messaging</p>
                </div>
                <form id="name-form" onsubmit="joinChat(event)">
                    <input id="name-input" placeholder="Your name..." autocomplete="off" maxlength="30" required/>
                    <button type="submit">
                        <span id="join-btn-text">Join Chat</span>
                        <span id="join-btn-spinner" class="loading-spinner hidden"></span>
                    </button>
                    </form>
            </div>
        </div>

        <div id="main-container" class="hidden">
            <div id="sidebar">
                <div id="sidebar-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 style="font-family: 'Poppins', sans-serif;">Online Users</h2>
                        <div style="display: flex; gap: 8px;">
                            <button id="sound-toggle" title="Toggle sound">ðŸ””</button>
                            <button id="theme-toggle" title="Change theme">ðŸŽ¨</button>
                            <button id="dark-mode-toggle" title="Toggle dark mode">ðŸŒ™</button>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #65676b; margin-bottom: 12px;">
                        <span id="user-count">0</span> users online
                    </div>
                </div>
                <ul id="online-users"></ul>
            </div>

            <div id="chat-area">
                <ul id="messages" role="log" aria-live="polite" aria-label="Chat messages"></ul>
                <div id="typing-indicator"></div>
                
                <div id="emoji-picker">
                    <div class="emoji-grid"></div>
                </div>

                <div id="mention-dropdown"></div>

                <div id="reply-preview">
                    <div class="reply-preview-content">
                        <div class="reply-preview-title">Replying to <span id="reply-to-name"></span></div>
                        <div class="reply-preview-text" id="reply-to-text"></div>
                    </div>
                    <button id="cancel-reply-btn">Ã—</button>
                </div>

                <div class="form-container">
                    <button id="emoji-picker-btn" type="button" aria-label="Add emoji">ðŸ˜Š</button>
                    <button id="file-attach-btn" type="button" aria-label="Attach file" title="Coming soon">ðŸ“Ž</button>
                    <div class="input-wrapper">
                        <form id="chat-form" onsubmit="sendMessage(event)">
                            <input 
                                id="messageText" 
                                placeholder="Type a message..." 
                                autocomplete="off"
                                maxlength="500"
                                aria-label="Message input"
                                oninput="updateCharCounter(); handleTyping(); handleMentionInput();"
                                onkeydown="handleInputKeydown(event);"
                            />
                            <span id="char-counter"></span>
                        </form>
                    </div>
                    <button form="chat-form" type="submit" aria-label="Send message">Send</button>
                </div>
            </div>
        </div>

        <script>
            var ws;
            var clientName;
            var typingTimeout;
            var isTyping = false;
            var soundEnabled = true;
            var onlineUsers = new Set();
            var darkMode = false;
            var replyingTo = null;
            var mentionDropdownIndex = -1;
            var mentionMatches = [];
            var messageHistory = [];
            var currentTheme = 'ocean';
            var unreadCount = 0;
            var isAtBottom = true;
            var messageReactions = {}; // Store reactions per message
            // MODIFIED: Removed calendarConnected variable

            // Emoji list
            const emojis = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜‡','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Œ','ðŸ˜','ðŸ¥°','ðŸ˜˜','ðŸ˜—','ðŸ˜™','ðŸ˜š','ðŸ˜‹','ðŸ˜›','ðŸ˜','ðŸ˜œ','ðŸ¤ª','ðŸ¤¨','ðŸ§','ðŸ¤“','ðŸ˜Ž','ðŸ¤©','ðŸ¥³','ðŸ˜','ðŸ˜’','ðŸ˜ž','ðŸ˜”','ðŸ˜Ÿ','ðŸ˜•','ðŸ™','â˜¹ï¸','ðŸ˜£','ðŸ˜–','ðŸ˜«','ðŸ˜©','ðŸ¥º','ðŸ˜¢','ðŸ˜­','ðŸ˜¤','ðŸ˜ ','ðŸ˜¡','ðŸ¤¬','ðŸ¤¯','ðŸ˜³','ðŸ¥µ','ðŸ¥¶','ðŸ˜±','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜“','ðŸ¤—','ðŸ¤”','ðŸ¤­','ðŸ¤«','ðŸ¤¥','ðŸ˜¶','ðŸ˜','ðŸ˜‘','ðŸ˜¬','ðŸ™„','ðŸ˜¯','ðŸ˜¦','ðŸ˜§','ðŸ˜®','ðŸ˜²','ðŸ¥±','ðŸ˜´','ðŸ¤¤','ðŸ˜ª','ðŸ˜µ','ðŸ¤','ðŸ¥´','ðŸ¤¢','ðŸ¤®','ðŸ¤§','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤‘','ðŸ¤ ','ðŸ‘','ðŸ‘Ž','ðŸ‘','ðŸ™Œ','ðŸ‘‹','ðŸ¤','ðŸŽ‰','ðŸŽŠ','â¤ï¸','ðŸ’•','ðŸ’–','âœ¨','â­','ðŸŒŸ','ðŸ’«','ðŸ”¥','ðŸ’¯'];

            // Initialize emoji picker
            function initEmojiPicker() {
                const emojiGrid = document.querySelector('.emoji-grid');
                emojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.className = 'emoji-item';
                    emojiItem.textContent = emoji;
                    emojiItem.onclick = () => insertEmoji(emoji);
                    emojiGrid.appendChild(emojiItem);
                });
            }

            // Toggle emoji picker
            document.getElementById('emoji-picker-btn').onclick = function() {
                const picker = document.getElementById('emoji-picker');
                picker.classList.toggle('show');
            };

            // Close emoji picker when clicking outside
            document.addEventListener('click', function(e) {
                const picker = document.getElementById('emoji-picker');
                const btn = document.getElementById('emoji-picker-btn');
                if (!picker.contains(e.target) && e.target !== btn) {
                    picker.classList.remove('show');
                }
            });

            // Insert emoji into input
            function insertEmoji(emoji) {
                const input = document.getElementById('messageText');
                input.value += emoji;
                input.focus();
                updateCharCounter();
                document.getElementById('emoji-picker').classList.remove('show');
            }

            // Character counter
            function updateCharCounter() {
                const input = document.getElementById('messageText');
                const counter = document.getElementById('char-counter');
                const remaining = 500 - input.value.length;
                
                if (remaining <= 0) {
                    counter.textContent = '0';
                    counter.className = 'error';
                } else if (remaining <= 50) {
                    counter.textContent = remaining;
                    counter.className = 'warning';
                } else if (remaining <= 100) {
                    counter.textContent = remaining;
                    counter.className = '';
                } else {
                    counter.textContent = '';
                    counter.className = '';
                }
            }

            // Theme switcher panel toggle
            document.getElementById('theme-toggle').onclick = function() {
                const switcher = document.getElementById('theme-switcher');
                switcher.classList.toggle('show');
            };

            // Dark mode toggle (separate button)
            document.getElementById('dark-mode-toggle').onclick = function() {
                darkMode = !darkMode;
                document.body.classList.toggle('dark-mode');
                this.textContent = darkMode ? 'â˜€ï¸' : 'ðŸŒ™';
                localStorage.setItem('darkMode', darkMode);
            };

            // Theme options
            document.querySelectorAll('.theme-option').forEach(option => {
                option.onclick = function() {
                    const theme = this.getAttribute('data-theme');
                    switchTheme(theme);
                };
            });

            function switchTheme(theme) {
                // Remove old theme classes
                document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-forest', 'theme-cyberpunk');
                document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                
                // Add new theme
                if (theme !== 'ocean') {
                    document.body.classList.add(`theme-${theme}`);
                }
                
                // Mark as active
                document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
                
                currentTheme = theme;
                localStorage.setItem('theme', theme);
                showToast('Theme changed!', `${theme.charAt(0).toUpperCase() + theme.slice(1)} theme activated`, 'success');
                
                // Hide switcher
                document.getElementById('theme-switcher').classList.remove('show');
            }

            // Load saved theme
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                darkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').textContent = 'â˜€ï¸';
            }

            const savedColorTheme = localStorage.getItem('theme');
            if (savedColorTheme) {
                switchTheme(savedColorTheme);
            }

            // Sound toggle
            document.getElementById('sound-toggle').onclick = function() {
                soundEnabled = !soundEnabled;
                this.textContent = soundEnabled ? 'ðŸ””' : 'ðŸ”•';
                showToast('Sound ' + (soundEnabled ? 'enabled' : 'disabled'), '', 'info');
            };

            // Toast notifications
            function showToast(title, message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icon = type === 'success' ? 'âœ“' : 'â„¹ï¸';
                toast.innerHTML = `
                    <span class="toast-icon">${icon}</span>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        ${message ? `<div class="toast-message">${message}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Play notification sound - improved bell sound
            function playNotificationSound() {
                if (!soundEnabled) return;
                
                // Create a more pleasant notification sound using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Pleasant two-tone bell notification
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.type = 'sine';
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            // Get avatar color based on name
            function getAvatarColor(name) {
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DFE6E9', '#74B9FF', '#A29BFE', '#FD79A8', '#FDCB6E'];
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                return colors[Math.abs(hash) % colors.length];
            }

            // Get initials from name
            function getInitials(name) {
                return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            }

            // Update online users list
            function updateOnlineUsers() {
                const usersList = document.getElementById('online-users');
                const userCount = document.getElementById('user-count');
                
                usersList.innerHTML = '';
                onlineUsers.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'user-avatar';
                    avatar.style.background = getAvatarColor(user);
                    avatar.textContent = getInitials(user);
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'online-indicator';
                    avatar.appendChild(indicator);
                    
                    const info = document.createElement('div');
                    info.className = 'user-info';
                    
                    const userName = document.createElement('div');
                    userName.className = 'user-name';
                    userName.textContent = user;
                    
                    const status = document.createElement('div');
                    status.className = 'user-status';
                    status.textContent = 'Online';
                    
                    info.appendChild(userName);
                    info.appendChild(status);
                    
                    li.appendChild(avatar);
                    li.appendChild(info);
                    usersList.appendChild(li);
                });
                
                userCount.textContent = onlineUsers.size;
            }

            // Handle typing indicator
            function handleTyping() {
                if (!isTyping) {
                    isTyping = true;
                    // You could send a "typing" event to the server here
                }
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    isTyping = false;
                    // You could send a "stopped typing" event to the server here
                }, 1000);
            }

            // Reply to message
            function replyToMessage(sender, message, messageElement) {
                replyingTo = { sender, message, messageElement };
                document.getElementById('reply-preview').classList.add('show');
                document.getElementById('reply-to-name').textContent = sender;
                document.getElementById('reply-to-text').textContent = message;
                document.getElementById('messageText').focus();
            }

            // Cancel reply
            document.getElementById('cancel-reply-btn').onclick = function() {
                replyingTo = null;
                document.getElementById('reply-preview').classList.remove('show');
            };

            // Detect and highlight mentions
            function formatMessageWithMentions(text) {
                // Replace @username patterns with styled mentions
                return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
            }

            // Check if message mentions current user
            function isMentioned(text, userName) {
                const mentionPattern = new RegExp('@' + userName + '\\b', 'i');
                return mentionPattern.test(text);
            }

            // Show mention dropdown
            function showMentionDropdown(query) {
                const dropdown = document.getElementById('mention-dropdown');
                mentionMatches = Array.from(onlineUsers).filter(user => 
                    user.toLowerCase().startsWith(query.toLowerCase()) && user !== clientName
                );
                
                if (mentionMatches.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                dropdown.innerHTML = mentionMatches.map((user, index) => {
                    const color = getAvatarColor(user);
                    const initials = getInitials(user);
                    return `
                        <div class="mention-item ${index === mentionDropdownIndex ? 'selected' : ''}" data-user="${user}">
                            <div class="mention-item-avatar" style="background: ${color}">${initials}</div>
                            <div class="mention-item-name">${escapeHtml(user)}</div>
                        </div>
                    `;
                }).join('');
                
                // Add click handlers
                dropdown.querySelectorAll('.mention-item').forEach((item, index) => {
                    item.onclick = () => selectMention(index);
                });
                
                dropdown.classList.add('show');
            }

            // Select mention from dropdown
            function selectMention(index) {
                if (index >= 0 && index < mentionMatches.length) {
                    const input = document.getElementById('messageText');
                    const value = input.value;
                    const lastAtIndex = value.lastIndexOf('@');
                    const selectedUser = mentionMatches[index];
                    input.value = value.substring(0, lastAtIndex) + '@' + selectedUser + ' ';
                    input.focus();
                    document.getElementById('mention-dropdown').classList.remove('show');
                    mentionDropdownIndex = -1;
                }
            }

            // Handle @ mentions in input
            function handleMentionInput() {
                const input = document.getElementById('messageText');
                const value = input.value;
                const cursorPos = input.selectionStart;
                
                // Find @ before cursor
                const textBeforeCursor = value.substring(0, cursorPos);
                const lastAtIndex = textBeforeCursor.lastIndexOf('@');
                
                if (lastAtIndex !== -1) {
                    const query = textBeforeCursor.substring(lastAtIndex + 1);
                    // Only show dropdown if no space after @
                    if (!query.includes(' ')) {
                        showMentionDropdown(query);
                        return;
                    }
                }
                
                document.getElementById('mention-dropdown').classList.remove('show');
                mentionDropdownIndex = -1;
            }

            // Show typing indicator (this would be triggered by server messages)
            function showTypingIndicator(userName) {
                const indicator = document.getElementById('typing-indicator');
                indicator.innerHTML = `
                    <span>${userName} is typing</span>
                    <span class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </span>
                `;
            }

            // Hide typing indicator
            function hideTypingIndicator() {
                document.getElementById('typing-indicator').innerHTML = '';
            }

            // Format timestamp
            function formatTime(date) {
                const hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHours = hours % 12 || 12;
                const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                return `${formattedHours}:${formattedMinutes} ${ampm}`;
            }

            // Join chat
            async function joinChat(event) {
                event.preventDefault();
                const nameInput = document.getElementById("name-input");
                clientName = nameInput.value.trim();
                
                // MODIFIED: Simplified validation
                if (clientName === "") { return; }

                // Show loading
                document.getElementById('join-btn-text').classList.add('hidden');
                document.getElementById('join-btn-spinner').classList.remove('hidden');

                // MODIFIED: Removed all /user/register and waitForCalendarAuth logic
                // We just proceed directly to the chat
                
                document.getElementById("name-container").classList.add("hidden");
                document.getElementById("main-container").classList.remove("hidden");

                ws = new WebSocket(`ws://${window.location.host}/ws/${clientName}`);
                
                ws.onopen = function() {
                    onlineUsers.add(clientName);
                    updateOnlineUsers();
                    // MODIFIED: Simplified toast message
                    showToast('Connected', `You joined the chat as ${clientName}`, 'success');
                    playNotificationSound();
                };
                
                ws.onmessage = function(event) {
                    hideTypingIndicator();
                    
                    var data = JSON.parse(event.data);
                    
                    if (!onlineUsers.has(data.sender)) {
                        onlineUsers.add(data.sender);
                        updateOnlineUsers();
                        if (data.sender !== clientName) {
                            showToast('User joined', `${data.sender} joined the chat`, 'info');
                            playNotificationSound();
                        }
                    }
                    
                    var messages = document.getElementById('messages');
                    var messageLi = document.createElement('li');
                    messageLi.setAttribute('role', 'listitem');

                    const timestamp = formatTime(new Date());
                    const mentioned = isMentioned(data.message, clientName);
                    const messageId = 'msg-' + Date.now() + '-' + Math.random();
                    messageLi.setAttribute('data-message-id', messageId);
                    
                    // Track unread if not at bottom
                    if (!isAtBottom && data.sender !== clientName) {
                        unreadCount++;
                        const badge = document.getElementById('unread-badge');
                        badge.textContent = unreadCount;
                        badge.classList.add('show');
                    }
                    
                    // Store message in history
                    messageHistory.push({
                        sender: data.sender,
                        message: data.message,
                        timestamp: timestamp,
                        element: messageLi,
                        id: messageId
                    });

                    if (data.sender === clientName) {
                        messageLi.classList.add('message-self');
                        
                        let contentHTML = '';
                        
                        // Check if this is a reply
                        if (data.replyTo) {
                            contentHTML += `
                                <div class="message-reply">
                                    <div class="reply-sender">${escapeHtml(data.replyTo.sender)}</div>
                                    <div class="reply-text">${escapeHtml(data.replyTo.message)}</div>
                                </div>
                            `;
                        }
                        
                        contentHTML += `
                            <div class="message-content">${formatMessageWithMentions(escapeHtml(data.message))}</div>
                            <div class="message-timestamp">${timestamp}</div>
                        `;
                        
                        messageLi.innerHTML = contentHTML;
                    } else {
                        messageLi.classList.add('message-other');
                        
                        // Add special styling if current user is mentioned
                        if (mentioned) {
                            messageLi.classList.add('message-mentioned');
                        }
                        
                        const avatarColor = getAvatarColor(data.sender);
                        const initials = getInitials(data.sender);
                        
                        let contentHTML = `
                            <div class="sender-info">
                                <div class="sender-avatar" style="background: ${avatarColor};">${initials}</div>
                                <span class="sender-name">${escapeHtml(data.sender)}</span>
                            </div>
                        `;
                        
                        // Check if this is a reply
                        if (data.replyTo) {
                            contentHTML += `
                                <div class="message-reply">
                                    <div class="reply-sender">${escapeHtml(data.replyTo.sender)}</div>
                                    <div class="reply-text">${escapeHtml(data.replyTo.message)}</div>
                                </div>
                            `;
                        }
                        
                        contentHTML += `
                            <div class="message-content">${formatMessageWithMentions(escapeHtml(data.message))}</div>
                            <div class="message-timestamp">${timestamp}</div>
                            <div class="message-actions">
                                <button class="message-action-btn" onclick="replyToMessage('${escapeHtml(data.sender)}', '${escapeHtml(data.message)}', this.closest('li'))" title="Reply">â†©ï¸</button>
                                <button class="message-action-btn" onclick="showReactionPicker(this.closest('li'))" title="React">ðŸ˜Š</button>
                            </div>
                        `;
                        
                        messageLi.innerHTML = contentHTML;
                        
                        playNotificationSound();
                        
                    }
                    
                    messages.appendChild(messageLi);
                    
                    // Smooth scroll to bottom if already at bottom
                    if (isAtBottom) {
                        setTimeout(() => {
                            messages.scrollTo({
                                top: messages.scrollHeight,
                                behavior: 'smooth'
                            });
                        }, 100);
                    }
                };

                ws.onclose = function() {
                    showToast('Disconnected', 'Connection closed', 'info');
                };

                ws.onerror = function(error) {
                    showToast('Error', 'Connection error occurred', 'info');
                    console.error('WebSocket error:', error);
                };
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Send message
            function sendMessage(event) {
                event.preventDefault();
                var input = document.getElementById("messageText");
                var messageText = input.value.trim();
                if (messageText === "" || messageText.length > 500) { return; }
                
                // If replying, create message object with reply data
                if (replyingTo) {
                    const messageData = JSON.stringify({
                        message: messageText,
                        replyTo: {
                            sender: replyingTo.sender,
                            message: replyingTo.message
                        }
                    });
                    ws.send(messageData);
                    
                    // Cancel reply
                    replyingTo = null;
                    document.getElementById('reply-preview').classList.remove('show');
                } else {
                    ws.send(messageText);
                }
                
                input.value = '';
                updateCharCounter();
                hideTypingIndicator();
                document.getElementById('mention-dropdown').classList.remove('show');
            }
            
            // Handle keyboard shortcuts in input
            function handleInputKeydown(event) {
                const dropdown = document.getElementById('mention-dropdown');
                
                // Handle mention dropdown navigation
                if (dropdown.classList.contains('show')) {
                    if (event.key === 'ArrowDown') {
                        event.preventDefault();
                        mentionDropdownIndex = Math.min(mentionDropdownIndex + 1, mentionMatches.length - 1);
                        showMentionDropdown(mentionMatches[0].substring(0, 1)); // Refresh display
                    } else if (event.key === 'ArrowUp') {
                        event.preventDefault();
                        mentionDropdownIndex = Math.max(mentionDropdownIndex - 1, 0);
                        showMentionDropdown(mentionMatches[0].substring(0, 1)); // Refresh display
                    } else if (event.key === 'Enter' && mentionDropdownIndex >= 0) {
                        event.preventDefault();
                        selectMention(mentionDropdownIndex);
                        return;
                    } else if (event.key === 'Escape') {
                        dropdown.classList.remove('show');
                        mentionDropdownIndex = -1;
                    }
                }
                
                // Handle Escape to cancel reply
                if (event.key === 'Escape' && replyingTo) {
                    replyingTo = null;
                    document.getElementById('reply-preview').classList.remove('show');
                }
            }

            // MODIFIED: Removed waitForCalendarAuth function
            // MODIFIED: Removed updateCalendarUI function

            // Scroll tracking for scroll-to-bottom button
            const messagesContainer = document.getElementById('messages');
            messagesContainer.addEventListener('scroll', function() {
                const threshold = 100;
                isAtBottom = (this.scrollHeight - this.scrollTop - this.clientHeight) < threshold;
                
                const scrollBtn = document.getElementById('scroll-to-bottom');
                if (!isAtBottom) {
                    scrollBtn.classList.add('show');
                } else {
                    scrollBtn.classList.remove('show');
                    unreadCount = 0;
                    document.getElementById('unread-badge').classList.remove('show');
                }
            });

            // Scroll to bottom button
            document.getElementById('scroll-to-bottom').onclick = function() {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
                unreadCount = 0;
                document.getElementById('unread-badge').classList.remove('show');
            };

            // Add reaction to message
            function addReaction(messageElement, emoji) {
                const messageId = messageElement.getAttribute('data-message-id');
                
                if (!messageReactions[messageId]) {
                    messageReactions[messageId] = {};
                }
                
                if (!messageReactions[messageId][emoji]) {
                    messageReactions[messageId][emoji] = 0;
                }
                
                messageReactions[messageId][emoji]++;
                updateReactionsDisplay(messageElement, messageId);
            }

            function updateReactionsDisplay(messageElement, messageId) {
                let reactionsContainer = messageElement.querySelector('.message-reactions');
                if (!reactionsContainer) {
                    reactionsContainer = document.createElement('div');
                    reactionsContainer.className = 'message-reactions';
                    messageElement.querySelector('.message-content').after(reactionsContainer);
                }
                
                reactionsContainer.innerHTML = '';
                const reactions = messageReactions[messageId];
                
                if (reactions) {
                    Object.keys(reactions).forEach(emoji => {
                        const count = reactions[emoji];
                        const reactionEl = document.createElement('div');
                        reactionEl.className = 'reaction';
                        reactionEl.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;
                        reactionEl.onclick = () => addReaction(messageElement, emoji);
                        reactionsContainer.appendChild(reactionEl);
                    });
                }
            }

            // Add reaction picker to message actions
            function showReactionPicker(messageElement) {
                const picker = document.createElement('div');
                picker.className = 'reaction-picker show';
                const reactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸŽ‰'];
                
                reactions.forEach(emoji => {
                    const option = document.createElement('div');
                    option.className = 'reaction-option';
                    option.textContent = emoji;
                    option.onclick = () => {
                        addReaction(messageElement, emoji);
                        picker.remove();
                    };
                    picker.appendChild(option);
                });
                
                messageElement.appendChild(picker);
                
                // Remove picker when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function removePicker(e) {
                        if (!picker.contains(e.target)) {
                            picker.remove();
                            document.removeEventListener('click', removePicker);
                        }
                    });
                }, 100);
            }

            // Close theme switcher when clicking outside
            document.addEventListener('click', function(e) {
                const switcher = document.getElementById('theme-switcher');
                const toggleBtn = document.getElementById('theme-toggle');
                if (!switcher.contains(e.target) && e.target !== toggleBtn) {
                    switcher.classList.remove('show');
                }
            });

            // Initialize
            initEmojiPicker();
            updateCharCounter();

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('messageText').focus();
                }
                
                // Close theme switcher with Escape
                if (e.key === 'Escape') {
                    document.getElementById('theme-switcher').classList.remove('show');
                }
            });

            // Focus input when page loads
            window.addEventListener('load', function() {
                document.getElementById('name-input').focus();
            });
        </script>
    </body>
</html>